#!/bin/bash
# -*- encoding: utf-8  coding: utf8-unix -*-

# I know this is a groddy hack: fork me!

steps_to_wiki () {
    local state=before
    local line
    
    cat $1 | \
    while read line ; do
	[ "$line" == "" ] && { continue ; }
	first=${line:0:1}
	if [ "$first" == "@" ] ; then
	    echo
            echo $line | sed -e "s/^@[a-z]*(u*[']/**/" -e "s/['])/**/"
	    state=before
	    continue
          fi
	sixth=${line:0:3}
	# shell strips the preceding whitespace on line
	if [ "$sixth" == '"""' ] || [ "$sixth" == 'r"""' ] ; then
	    if [ "$state" == "before" ] ; then
		state=in
	        continue
	      fi
	    if [ "$state" == "in" ] ; then
		state=outside
	        continue
	      fi
	  fi
	if [ "$state" == "in" ] ; then
	    echo "   $line" | sed -e 's/[|]\([^ ]*\)[|]/{{{|\1|}}}/g'
	  fi
      done
}

grep -l ^@ features/steps/*py | \
    grep -v '/support/\|__init__' | \
    while read file ; do
	outfile=wiki/`echo $file | sed -e 's@^.*features/steps/@Steps_@' -e 's@/@-@g' -e 's@py$@creole@'`
	steps_to_wiki "$file" >> ${outfile}
	[ -s ${outfile} ] || { rm -f ${outfile} ; continue ; }
	echo -e "# -*- mode: text; fill-column: 75; coding: utf-8-unix; encoding: utf-8 -*-\n" > foo
	echo -e "From: [[$file|$file]]\n\n" >> foo
	cat ${outfile} >> foo
	echo '----' >> foo
	echo "This file is automatically generated from the source code: do not edit." >> foo
	mv foo ${outfile}
      done
